#include "debug.h"
#include "ccd.h"
#include "math.h"
#include "usart.h"

u8 SciBuf[200];  //存储上传到上位机的信息
u16 piexl[128]={//测试上位机用
0x49,0x3B,0x33,0x2D,0x2E,0x2E,0x2D,0x2D,0x2D,0x2D,0x2D,0x2E,0x2E,0x2E,0x2E,0x2F,0x30,0x35,0x30,0x35,
0x35,0xA6,0xA8,0x8F,0x80,0x5A,0x40,0x44,0x44,0x7D,0xA8,0xA8,0xA8,0xA8,0xA8,0xA8,0xA9,0xA9,0xA9,0xA9, 
0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9, 
0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0x95,0x71,0x4F,0x53,0x45,0x5E,0xA8,0xA8,0xA8,0xA8,0xA8,0xA9,
0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,
0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0xA9,0x95,0x78,0x59,0x48,
0x44,0x38,0x49,0x84,0x7B,0x72,0x53,0x40};

//串口发送一个字节
void usart1_send(u8 data)
{
	USART1->DR = data;
	while((USART1->SR&0x40)==0);	
}


//将从CCD中读取到的信息按照上位机要求的通信协议存入到数组中以待发送
void slove_data(void)
{
	int i;
	RD_TSL();
  SciBuf[0] = 0; 
	SciBuf[1] = 132;
  SciBuf[2] = 0; 
  SciBuf[3] = 0;
	SciBuf[4] = 0;
  SciBuf[5] = 0; 
	for(i=0;i<128;i++)
		SciBuf[6+i] = ccd_piexl[i];
}

//将待发送的信息通过串口发送至蓝宙上位机
void Landzo_CCD_Data(void)
{ 
	int i;
	slove_data();
	printf("*");
	printf("LD");
	for(i=2;i<134;i++)
	{ 
			printf("%c",binToHex_high(SciBuf[i])); //以字符形式发送高4位对应的16进制
			printf("%c",binToHex_low(SciBuf[i]));  //以字符形式发送低?位对应的16进制
	}
	printf("00");   //通信协议要求
	printf("#");    //通信协议要求
	printf("\n");
}

//CCD数据采集 发送至拉普兰德上位机
void LPLD_CCD_Data(void)   
{
	int j;
//  RD_TSL();
	for(j=0;j<128;j++)
	{
		if(ccd_piexl[j] ==  0Xff)  
			usart1_send(0xfe);    
		else
			usart1_send(ccd_piexl[j]);
  }   
	usart1_send(0xff);
}

//发送至多功能调试助手
void Multi_CCD_Data(void)   
{ 
	int j;
//  RD_TSL();
	usart1_send(0x02);
	usart1_send(0xfd);
	for(j=0;j<128;j++)
	{
			usart1_send(ccd_piexl[j]);
  }
	usart1_send(0xfd);
	usart1_send(0x02);
}

//将二进制低8位转换16进制*	 	 
char binToHex_low(u8 num)
{
	u8 low_four;
  low_four=num&0x0f;
  return (low_four-0)<10?'0'+low_four:'A'+(low_four-10); 
}


// 将二进制高8位转换16进制*					 
char binToHex_high(u8 num)
{
	u8 high_four;
	high_four=(num>>4)&0x0f;
	return (high_four-0)<10?'0'+high_four:'A'+(high_four-10); 
}

//调试函数
void Debug(void(*debug)(void))
{
	#if DEBUG_MODE
		debug();     //传入调试函数
	#endif
}

